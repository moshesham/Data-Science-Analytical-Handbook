name: Convert Notebooks to Markdown

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.ipynb'
  pull_request:
    paths:
      - '**/*.ipynb'
  workflow_dispatch:

# Prevent multiple runs for the same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install nbconvert
        run: |
          python -m pip install --upgrade pip
          python -m pip install nbconvert==7.16.4 jupyter

      - name: Convert notebooks to Markdown
        run: |
          python - <<'PY'
          import pathlib
          import subprocess

          repo = pathlib.Path('.').resolve()
          output_root = repo / 'notebooks_md'
          output_root.mkdir(exist_ok=True)

          notebook_paths = list(repo.rglob('*.ipynb'))
          if not notebook_paths:
              print('No notebooks found, skipping conversion.')
              raise SystemExit(0)

          for nb_path in notebook_paths:
              # Skip typical checkpoint folders
              if '.ipynb_checkpoints' in nb_path.parts:
                  continue

              relative = nb_path.relative_to(repo)
              target_dir = output_root / relative.parent
              target_dir.mkdir(parents=True, exist_ok=True)
              target_md = target_dir / (nb_path.stem + '.md')

              cmd = [
                  'jupyter', 'nbconvert', '--to', 'markdown', '--output', target_md.name,
                  '--output-dir', str(target_dir), str(nb_path)
              ]
              print('Converting', nb_path, '->', target_md)
              subprocess.run(cmd, check=True)
          PY

      - name: Upload converted notebooks (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: notebooks-md
          path: notebooks_md
          retention-days: 30

      - name: Commit converted notebooks
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add notebooks_md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update converted notebooks [skip ci]"
            git push
          fi

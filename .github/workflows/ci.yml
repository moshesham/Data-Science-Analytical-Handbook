name: CI

on:
  push:
    branches: [ main, CI-CD-workflow ]
  pull_request:
    branches: [ main, CI-CD-workflow ]

jobs:
  lint-python:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    - name: Format with black
      run: black --check --diff .

  validate-notebooks:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        # Install test tooling + runtime dependencies used by notebooks.
        # If a dedicated requirements file exists, use it for reproducible installs.
        if [ -f requirements-notebooks.txt ]; then pip install -r requirements-notebooks.txt; else pip install nbval jupyter pytest numpy pandas scipy statsmodels ipywidgets matplotlib seaborn scikit-learn; fi
    - name: Validate notebooks
      run: |
        python -m pytest --nbval --ignore=streamlit_app/Product_Analytics/data/

  check-markdown:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Check markdown links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        check-modified-files-only: 'yes'

  validate-html:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    - name: Install dependencies
      run: pip install html5validator
    - name: Validate HTML
      run: html5validator --root html_source/ --ignore-re "Archive/" --ignore-re "foundational_knowledge/" --ignore-re "interview_preparation/" --also-check-css

  test-streamlit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r streamlit_app/Product_Analytics/requirements.txt
    - name: Test Streamlit app startup
      run: |
        timeout 10 streamlit run streamlit_app/Product_Analytics/streamlit_app.py --server.headless true --server.port 8501 &
        sleep 5
        curl -f http://localhost:8501 || exit 1
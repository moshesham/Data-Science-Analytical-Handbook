name: CI

on:
  push:
    branches: [ main, workflow-fix ]
  pull_request:
    branches: [ main, workflow-fix ]
  workflow_dispatch:

# Prevent multiple CI runs for the same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  python-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements-dev.txt
            requirements-notebooks.txt
      
      - name: Cache virtualenv
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: .venv-dev
          key: ${{ runner.os }}-python-3.11-venv-dev-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-python-3.11-venv-dev-
      
      - name: Install dependencies
        run: |
          if [ ! -d .venv-dev ]; then python -m venv .venv-dev; fi
          . .venv-dev/bin/activate
          python -m pip install --upgrade pip
          if [ "${{ steps.cache-venv.outputs.cache-hit }}" != 'true' ]; then
            pip install -r requirements-dev.txt || pip install flake8 black isort pytest nbval
            if [ -f requirements-notebooks.txt ]; then pip install -r requirements-notebooks.txt; fi
          else
            echo "Virtualenv cache hit - skipping bulk installs"
          fi
      
      - name: isort check
        run: . .venv-dev/bin/activate && isort --profile black --check-only --skip-glob=".venv-*" .
      
      - name: black check
        run: . .venv-dev/bin/activate && black --check --exclude="/(\.venv-.*|\.git|__pycache__|_site|html_source)/" .
      
      - name: flake8 strict
        run: . .venv-dev/bin/activate && flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      
      - name: flake8 warnings
        run: . .venv-dev/bin/activate && flake8 . --count --exit-zero --max-complexity=10 --statistics
        continue-on-error: true
      
      - name: Notebook tests (nbval)
        run: |
          if find . -name '*.ipynb' -print -quit | grep -q .; then
            . .venv-dev/bin/activate
            pytest --nbval --ignore=streamlit_app/Product_Analytics/data/ --ignore=Analytical-HandsOn-Projects/ || EXIT_CODE=$?
            if [ "${EXIT_CODE:-0}" -ne 0 ]; then
              echo "Notebook validation failed" > notebook-fail.log
              exit $EXIT_CODE
            fi
          else
            echo "No notebooks found; skipping." > notebook-skip.log
          fi
      
      - name: Upload notebook logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: notebook-logs
          path: |
            notebook-fail.log
            notebook-skip.log
          retention-days: 7

  markdown-links:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Cache npm packages
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-markdown-links-${{ hashFiles('package*.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-markdown-links-
            ${{ runner.os }}-npm-
      
      - name: Run markdown-link-check (via npx)
        run: |
          if [ -f .markdown-link-check.json ]; then
            find . -name '*.md' -print0 | xargs -0 -n1 -P4 npx -y markdown-link-check -q -c .markdown-link-check.json || exit 1
          else
            find . -name '*.md' -print0 | xargs -0 -n1 -P4 npx -y markdown-link-check -q || exit 1
          fi

  streamlit-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'streamlit_app/Product_Analytics/requirements.txt'
      
      - name: Cache Streamlit virtualenv
        id: cache-venv-streamlit
        uses: actions/cache@v4
        with:
          path: .venv-streamlit
          key: ${{ runner.os }}-python-3.11-venv-streamlit-${{ hashFiles('streamlit_app/Product_Analytics/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-python-3.11-venv-streamlit-
      
      - name: Install dependencies
        run: |
          if [ ! -d .venv-streamlit ]; then python -m venv .venv-streamlit; fi
          . .venv-streamlit/bin/activate
          python -m pip install --upgrade pip
          if [ "${{ steps.cache-venv-streamlit.outputs.cache-hit }}" != 'true' ]; then
            pip install -r streamlit_app/Product_Analytics/requirements.txt || pip install streamlit
          else
            echo "Streamlit virtualenv cache hit - skipping installs"
          fi
      
      - name: Start Streamlit (background)
        run: |
          . .venv-streamlit/bin/activate
          streamlit run streamlit_app/Product_Analytics/streamlit_app.py --server.headless true --server.port 8501 > streamlit.log 2>&1 &
          for i in 1 2 3 4 5; do
            sleep 2
            if curl -fsS http://127.0.0.1:8501 >/dev/null; then echo "Streamlit up"; exit 0; fi
          done
          echo "Streamlit failed to start" >&2
          cat streamlit.log
          exit 1
      
      - name: Upload Streamlit log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: streamlit-log
          path: streamlit.log
          retention-days: 7
  summary:
    runs-on: ubuntu-latest
    if: always()
    needs: [python-quality, markdown-links, streamlit-smoke]
    steps:
      - name: Build CI summary
        run: |
          echo "### CI Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Python quality: ${{ needs.python-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Markdown links: ${{ needs.markdown-links.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Streamlit smoke: ${{ needs.streamlit-smoke.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- Notebook logs (if any failures)" >> $GITHUB_STEP_SUMMARY
          echo "- Streamlit startup log" >> $GITHUB_STEP_SUMMARY
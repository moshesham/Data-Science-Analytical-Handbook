<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Advanced SQL Patterns and Techniques</title>
    <meta name="description" content="A handbook for preparing for analytical/data-science interviews">

    <!-- MathJax -->
    <script async src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">

    <!-- Site CSS -->
    <link rel="stylesheet" href="/assets/css/style.css">
  </head>
  <body>
    <aside class="sidebar">
  <h2>Contents</h2>
  <ul class="nav-list">
    <li><a href="/introduction/" class="">I. Introduction</a>
      <ul>
        <li><a href="/introduction/#welcome">1. Welcome and Purpose of this Handbook</a></li>
        <li><a href="/introduction/#meta-data-science-role">2. What to Expect: The Meta Data Science Role</a></li>
        <li><a href="/introduction/#interview-process">3. Navigating the Meta Interview Process</a></li>
        <li><a href="/introduction/#handbook-usage">4. How to Use This Handbook</a></li>
      </ul>
    </li>
    <li><a href="/foundational_knowledge/1/">II. Foundational Knowledge & Skills</a></li>
    <li><a href="/interview_preparation/technical_skills/">III. Interview Preparation</a></li>
    <li><a href="/meta_specificity/">IV. Meta Specificity</a></li>
    <li><a href="/resources_practice/">V. Resources and Practice</a></li>
    <li><a href="/conclusion/">VI. Conclusion</a></li>
    <li><a href="/appendix/">Appendix</a></li>
  </ul>
</aside>


    <main class="main-content">
      <h1 id="advanced-sql-patterns-and-techniques">Advanced SQL Patterns and Techniques</h1>
<p><em>Extended Guide for Complex SQL Problems</em></p>

<h2 id="1-advanced-window-function-patterns">1. Advanced Window Function Patterns</h2>

<h3 id="introduction-to-complex-windows">Introduction to Complex Windows</h3>
<p>Window functions are powerful tools for analyzing data across rows. This section explores advanced patterns that go beyond basic window functions.</p>

<h3 id="frame-specifications">Frame Specifications</h3>
<h4 id="rows-vs-range">ROWS vs RANGE</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- ROWS example: exactly 3 previous rows</span>
<span class="k">SUM</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">transaction_date</span>
    <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">3</span> <span class="k">PRECEDING</span> <span class="k">AND</span> <span class="k">CURRENT</span> <span class="k">ROW</span>
<span class="p">)</span>

<span class="c1">-- RANGE example: all rows within 3 days</span>
<span class="k">SUM</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">transaction_date</span>
    <span class="k">RANGE</span> <span class="k">BETWEEN</span> <span class="n">INTERVAL</span> <span class="s1">'3'</span> <span class="k">DAY</span> <span class="k">PRECEDING</span> <span class="k">AND</span> <span class="k">CURRENT</span> <span class="k">ROW</span>
<span class="p">)</span>
</code></pre></div></div>

<h3 id="gap-and-island-detection">Gap and Island Detection</h3>
<p>A common pattern for finding consecutive sequences or gaps in data.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Finding gaps in sequential IDs</span>
<span class="k">WITH</span> <span class="n">numbered</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> 
    <span class="n">id</span><span class="p">,</span>
    <span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">id</span><span class="p">)</span> <span class="k">as</span> <span class="n">rn</span>
  <span class="k">FROM</span> <span class="n">sequences</span>
<span class="p">),</span>
<span class="n">gaps</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> 
    <span class="n">id</span><span class="p">,</span>
    <span class="n">id</span> <span class="o">-</span> <span class="n">rn</span> <span class="k">as</span> <span class="n">grp</span>
  <span class="k">FROM</span> <span class="n">numbered</span>
<span class="p">)</span>
<span class="k">SELECT</span> 
  <span class="k">MIN</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">as</span> <span class="n">gap_start</span><span class="p">,</span>
  <span class="k">MAX</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">as</span> <span class="n">gap_end</span><span class="p">,</span>
  <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">as</span> <span class="n">gap_size</span>
<span class="k">FROM</span> <span class="n">gaps</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">grp</span>
<span class="k">HAVING</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="running-totals-with-reset-conditions">Running Totals with Reset Conditions</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Running total that resets each month</span>
<span class="k">SELECT</span> 
  <span class="n">transaction_date</span><span class="p">,</span>
  <span class="n">amount</span><span class="p">,</span>
  <span class="k">SUM</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span>
    <span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'month'</span><span class="p">,</span> <span class="n">transaction_date</span><span class="p">)</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">transaction_date</span>
  <span class="p">)</span> <span class="k">as</span> <span class="n">monthly_running_total</span>
<span class="k">FROM</span> <span class="n">transactions</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="percentile-analysis">Percentile Analysis</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Complex percentile calculations</span>
<span class="k">SELECT</span> 
  <span class="n">product_id</span><span class="p">,</span>
  <span class="n">price</span><span class="p">,</span>
  <span class="n">PERCENT_RANK</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">price</span><span class="p">)</span> <span class="k">as</span> <span class="n">price_percentile</span><span class="p">,</span>
  <span class="k">CASE</span> 
    <span class="k">WHEN</span> <span class="n">PERCENT_RANK</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">price</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">25</span> <span class="k">THEN</span> <span class="s1">'Budget'</span>
    <span class="k">WHEN</span> <span class="n">PERCENT_RANK</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">price</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">75</span> <span class="k">THEN</span> <span class="s1">'Mid-Range'</span>
    <span class="k">ELSE</span> <span class="s1">'Premium'</span>
  <span class="k">END</span> <span class="k">as</span> <span class="n">price_category</span>
<span class="k">FROM</span> <span class="n">products</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="2-real-world-data-quality-patterns">2. Real-World Data Quality Patterns</h2>

<h3 id="fuzzy-matching-techniques">Fuzzy Matching Techniques</h3>

<h4 id="using-similarity-functions">Using Similarity Functions</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Comprehensive fuzzy matching</span>
<span class="k">WITH</span> <span class="n">similarity_metrics</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> 
    <span class="n">a</span><span class="p">.</span><span class="n">customer_id</span> <span class="k">as</span> <span class="n">id1</span><span class="p">,</span>
    <span class="n">b</span><span class="p">.</span><span class="n">customer_id</span> <span class="k">as</span> <span class="n">id2</span><span class="p">,</span>
    <span class="n">similarity</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">name_sim</span><span class="p">,</span>
    <span class="n">similarity</span><span class="p">(</span>
      <span class="n">regexp_replace</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">email</span><span class="p">,</span> <span class="s1">'@.*$'</span><span class="p">,</span> <span class="s1">''</span><span class="p">),</span>
      <span class="n">regexp_replace</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">email</span><span class="p">,</span> <span class="s1">'@.*$'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">email_sim</span><span class="p">,</span>
    <span class="n">levenshtein</span><span class="p">(</span>
      <span class="n">regexp_replace</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="s1">'[^0-9]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">),</span>
      <span class="n">regexp_replace</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="s1">'[^0-9]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">phone_distance</span>
  <span class="k">FROM</span> <span class="n">customers</span> <span class="n">a</span>
  <span class="k">JOIN</span> <span class="n">customers</span> <span class="n">b</span> <span class="k">ON</span> <span class="n">a</span><span class="p">.</span><span class="n">customer_id</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">customer_id</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">similarity_metrics</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">name_sim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span> <span class="k">AND</span> <span class="n">email_sim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">7</span><span class="p">)</span>
   <span class="k">OR</span> <span class="p">(</span><span class="n">name_sim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">7</span> <span class="k">AND</span> <span class="n">phone_distance</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="data-consistency-checks">Data Consistency Checks</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Comprehensive data validation</span>
<span class="k">WITH</span> <span class="n">validation_checks</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="k">table_name</span><span class="p">,</span>
    <span class="k">column_name</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_rows</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">column_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">non_null_rows</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">column_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">unique_values</span><span class="p">,</span>
    <span class="k">MIN</span><span class="p">(</span><span class="k">column_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">min_value</span><span class="p">,</span>
    <span class="k">MAX</span><span class="p">(</span><span class="k">column_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">max_value</span><span class="p">,</span>
    <span class="k">AVG</span><span class="p">(</span><span class="k">CASE</span> 
      <span class="k">WHEN</span> <span class="k">column_name</span> <span class="o">~</span> <span class="s1">'^[0-9]+$'</span> 
      <span class="k">THEN</span> <span class="k">column_name</span><span class="p">::</span><span class="nb">numeric</span> 
      <span class="k">ELSE</span> <span class="k">NULL</span> 
    <span class="k">END</span><span class="p">)</span> <span class="k">as</span> <span class="n">avg_numeric_value</span>
  <span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span> <span class="k">c</span>
  <span class="k">JOIN</span> <span class="n">your_table</span> <span class="n">t</span> <span class="k">ON</span> <span class="k">true</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="k">table_name</span><span class="p">,</span> <span class="k">column_name</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">validation_checks</span>
<span class="k">WHERE</span> <span class="n">non_null_rows</span> <span class="o">&lt;</span> <span class="n">total_rows</span>
   <span class="k">OR</span> <span class="n">unique_values</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="3-time-series-analysis-patterns">3. Time Series Analysis Patterns</h2>

<h3 id="period-over-period-analysis">Period-over-Period Analysis</h3>

<h4 id="complex-comparisons">Complex Comparisons</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">daily_metrics</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="nb">date</span><span class="p">,</span>
    <span class="k">SUM</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span> <span class="k">as</span> <span class="n">revenue</span><span class="p">,</span>
    <span class="n">LAG</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">revenue</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="nb">date</span><span class="p">)</span> <span class="k">as</span> <span class="n">prev_day</span><span class="p">,</span>
    <span class="n">LAG</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">revenue</span><span class="p">),</span> <span class="mi">7</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="nb">date</span><span class="p">)</span> <span class="k">as</span> <span class="n">prev_week</span><span class="p">,</span>
    <span class="n">LAG</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">revenue</span><span class="p">),</span> <span class="mi">30</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="nb">date</span><span class="p">)</span> <span class="k">as</span> <span class="n">prev_month</span>
  <span class="k">FROM</span> <span class="n">sales</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="nb">date</span>
<span class="p">),</span>
<span class="n">growth_metrics</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="nb">date</span><span class="p">,</span>
    <span class="n">revenue</span><span class="p">,</span>
    <span class="p">(</span><span class="n">revenue</span> <span class="o">-</span> <span class="n">prev_day</span><span class="p">)</span> <span class="o">/</span> <span class="k">NULLIF</span><span class="p">(</span><span class="n">prev_day</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">as</span> <span class="n">daily_growth</span><span class="p">,</span>
    <span class="p">(</span><span class="n">revenue</span> <span class="o">-</span> <span class="n">prev_week</span><span class="p">)</span> <span class="o">/</span> <span class="k">NULLIF</span><span class="p">(</span><span class="n">prev_week</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">as</span> <span class="n">weekly_growth</span><span class="p">,</span>
    <span class="p">(</span><span class="n">revenue</span> <span class="o">-</span> <span class="n">prev_month</span><span class="p">)</span> <span class="o">/</span> <span class="k">NULLIF</span><span class="p">(</span><span class="n">prev_month</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">as</span> <span class="n">monthly_growth</span>
  <span class="k">FROM</span> <span class="n">daily_metrics</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">growth_metrics</span>
<span class="k">WHERE</span> <span class="k">ABS</span><span class="p">(</span><span class="n">daily_growth</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span>  <span class="c1">-- Significant daily changes</span>
   <span class="k">OR</span> <span class="k">ABS</span><span class="p">(</span><span class="n">weekly_growth</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">;</span>  <span class="c1">-- Significant weekly changes</span>
</code></pre></div></div>

<h3 id="seasonal-analysis">Seasonal Analysis</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Detecting seasonality</span>
<span class="k">WITH</span> <span class="n">monthly_sales</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'month'</span><span class="p">,</span> <span class="nb">date</span><span class="p">)</span> <span class="k">as</span> <span class="k">month</span><span class="p">,</span>
    <span class="k">SUM</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span> <span class="k">as</span> <span class="n">revenue</span>
  <span class="k">FROM</span> <span class="n">sales</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">'month'</span><span class="p">,</span> <span class="nb">date</span><span class="p">)</span>
<span class="p">),</span>
<span class="n">seasonal_indices</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="k">EXTRACT</span><span class="p">(</span><span class="k">month</span> <span class="k">FROM</span> <span class="k">month</span><span class="p">)</span> <span class="k">as</span> <span class="n">month_num</span><span class="p">,</span>
    <span class="k">AVG</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span> <span class="k">as</span> <span class="n">avg_revenue</span><span class="p">,</span>
    <span class="k">AVG</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">()</span> <span class="k">as</span> <span class="n">global_avg</span><span class="p">,</span>
    <span class="k">AVG</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span> <span class="o">/</span> <span class="k">NULLIF</span><span class="p">(</span><span class="k">AVG</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">seasonal_index</span>
  <span class="k">FROM</span> <span class="n">monthly_sales</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="k">EXTRACT</span><span class="p">(</span><span class="k">month</span> <span class="k">FROM</span> <span class="k">month</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">seasonal_indices</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">month_num</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="4-performance-optimization-patterns">4. Performance Optimization Patterns</h2>

<h3 id="query-plan-analysis">Query Plan Analysis</h3>

<h4 id="identifying-bottlenecks">Identifying Bottlenecks</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXPLAIN</span> <span class="k">ANALYZE</span>
<span class="k">SELECT</span> 
  <span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span>
  <span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
  <span class="k">COUNT</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">order_count</span><span class="p">,</span>
  <span class="k">SUM</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">total_amount</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_spent</span>
<span class="k">FROM</span> <span class="n">customers</span> <span class="k">c</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">orders</span> <span class="n">o</span> <span class="k">ON</span> <span class="k">c</span><span class="p">.</span><span class="n">customer_id</span> <span class="o">=</span> <span class="n">o</span><span class="p">.</span><span class="n">customer_id</span>
<span class="k">WHERE</span> <span class="n">o</span><span class="p">.</span><span class="n">order_date</span> <span class="o">&gt;=</span> <span class="k">CURRENT_DATE</span> <span class="o">-</span> <span class="n">INTERVAL</span> <span class="s1">'1 year'</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">name</span>
<span class="k">HAVING</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="index-design-patterns">Index Design Patterns</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Composite index for range + equality predicates</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_orders_customer_date</span> <span class="k">ON</span> <span class="n">orders</span> <span class="p">(</span>
  <span class="n">customer_id</span><span class="p">,</span>  <span class="c1">-- equality predicate first</span>
  <span class="n">order_date</span>    <span class="c1">-- range predicate second</span>
<span class="p">);</span>

<span class="c1">-- Covering index for common query</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_orders_summary</span> <span class="k">ON</span> <span class="n">orders</span> <span class="p">(</span>
  <span class="n">customer_id</span><span class="p">,</span>
  <span class="n">order_date</span><span class="p">,</span>
  <span class="n">total_amount</span>
<span class="p">)</span> <span class="n">INCLUDE</span> <span class="p">(</span><span class="n">order_id</span><span class="p">);</span>  <span class="c1">-- included for covering</span>
</code></pre></div></div>

<h3 id="materialized-views">Materialized Views</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Creating an efficient materialized view</span>
<span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">mv_customer_summary</span> <span class="k">AS</span>
<span class="k">SELECT</span> 
  <span class="n">customer_id</span><span class="p">,</span>
  <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">order_count</span><span class="p">,</span>
  <span class="k">SUM</span><span class="p">(</span><span class="n">total_amount</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_spent</span><span class="p">,</span>
  <span class="k">MAX</span><span class="p">(</span><span class="n">order_date</span><span class="p">)</span> <span class="k">as</span> <span class="n">last_order_date</span>
<span class="k">FROM</span> <span class="n">orders</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">customer_id</span>
<span class="k">WITH</span> <span class="k">DATA</span><span class="p">;</span>

<span class="c1">-- Create unique index for efficient refreshes</span>
<span class="k">CREATE</span> <span class="k">UNIQUE</span> <span class="k">INDEX</span> <span class="n">idx_mv_customer_summary</span> 
<span class="k">ON</span> <span class="n">mv_customer_summary</span> <span class="p">(</span><span class="n">customer_id</span><span class="p">);</span>

<span class="c1">-- Refresh strategy</span>
<span class="n">REFRESH</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">CONCURRENTLY</span> <span class="n">mv_customer_summary</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="common-performance-patterns">Common Performance Patterns</h3>

<h4 id="before-optimization">Before Optimization</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Inefficient query</span>
<span class="k">SELECT</span> 
  <span class="n">p</span><span class="p">.</span><span class="n">product_name</span><span class="p">,</span>
  <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">unique_customers</span><span class="p">,</span>
  <span class="k">SUM</span><span class="p">(</span><span class="n">oi</span><span class="p">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">oi</span><span class="p">.</span><span class="n">unit_price</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_revenue</span>
<span class="k">FROM</span> <span class="n">products</span> <span class="n">p</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span> <span class="k">ON</span> <span class="n">p</span><span class="p">.</span><span class="n">product_id</span> <span class="o">=</span> <span class="n">oi</span><span class="p">.</span><span class="n">product_id</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">orders</span> <span class="n">o</span> <span class="k">ON</span> <span class="n">oi</span><span class="p">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">o</span><span class="p">.</span><span class="n">order_id</span>
<span class="k">WHERE</span> <span class="n">o</span><span class="p">.</span><span class="n">order_date</span> <span class="o">&gt;=</span> <span class="k">CURRENT_DATE</span> <span class="o">-</span> <span class="n">INTERVAL</span> <span class="s1">'1 year'</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">product_name</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="after-optimization">After Optimization</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Optimized version</span>
<span class="k">WITH</span> <span class="n">order_metrics</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> 
    <span class="n">oi</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">unique_customers</span><span class="p">,</span>
    <span class="k">SUM</span><span class="p">(</span><span class="n">oi</span><span class="p">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">oi</span><span class="p">.</span><span class="n">unit_price</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_revenue</span>
  <span class="k">FROM</span> <span class="n">order_items</span> <span class="n">oi</span>
  <span class="k">JOIN</span> <span class="n">orders</span> <span class="n">o</span> <span class="k">ON</span> <span class="n">oi</span><span class="p">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">o</span><span class="p">.</span><span class="n">order_id</span>
  <span class="k">WHERE</span> <span class="n">o</span><span class="p">.</span><span class="n">order_date</span> <span class="o">&gt;=</span> <span class="k">CURRENT_DATE</span> <span class="o">-</span> <span class="n">INTERVAL</span> <span class="s1">'1 year'</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">oi</span><span class="p">.</span><span class="n">product_id</span>
<span class="p">)</span>
<span class="k">SELECT</span> 
  <span class="n">p</span><span class="p">.</span><span class="n">product_name</span><span class="p">,</span>
  <span class="n">COALESCE</span><span class="p">(</span><span class="n">om</span><span class="p">.</span><span class="n">unique_customers</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">unique_customers</span><span class="p">,</span>
  <span class="n">COALESCE</span><span class="p">(</span><span class="n">om</span><span class="p">.</span><span class="n">total_revenue</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_revenue</span>
<span class="k">FROM</span> <span class="n">products</span> <span class="n">p</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">order_metrics</span> <span class="n">om</span> <span class="k">ON</span> <span class="n">p</span><span class="p">.</span><span class="n">product_id</span> <span class="o">=</span> <span class="n">om</span><span class="p">.</span><span class="n">product_id</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="best-practices-checklist">Best Practices Checklist</h3>
<ol>
  <li>Always analyze query plans with <code class="language-plaintext highlighter-rouge">EXPLAIN ANALYZE</code></li>
  <li>Design indexes based on query patterns</li>
  <li>Consider materialized views for expensive calculations</li>
  <li>Use CTEs for better readability and optimization</li>
  <li>Minimize the number of joins when possible</li>
  <li>Use covering indexes for frequent queries</li>
  <li>Regularly update statistics with <code class="language-plaintext highlighter-rouge">ANALYZE</code></li>
  <li>Monitor and maintain materialized view refresh schedules</li>
</ol>


      <footer>
        <p>Â© 2025 </p>
      </footer>
    </main>
  </body>
</html>
